name: CI

on:
  workflow_dispatch:
    inputs:
      kernel-branch:
        required: true
        type: string
      release-type:
        required: true
        type: choice
        options:
        - WIP
        - release
        default: 'WIP'
      device-codename:
        required: true
        type: choice
        options:
        - a71
        - a715

jobs:
  build-kernel:
    name: Build Kernel
    runs-on: ubuntu-latest
    steps:
      - name: Display parameters
        uses: m-s-abeer/update-gha-summary-with-workflow-inputs@v1

      - name: Build
        uses: frstprjkt/kernel_build_action@main
        with:
          kernel-url: https://github.com/SAM-715-ID/kernel_Bekicot
          kernel-branch: ${{ github.event.inputs.kernel-branch }}
          config: sdmmagpie_defconfig a71.config
          arch: arm64
          aosp-gcc: true
          aosp-clang: true
          aosp-clang-version: r563880
          anykernel3: true
          anykernel3-url: https://github.com/SAM-715-ID/AnyKernel3
          anykernel3-branch: ${{ github.event.inputs.device-codename }}
          extra-cmd: LLVM=1 LLVM_IAS=1 KBUILD_BUILD_USER=KeongBalap
          custom-package-name: Bekicot_$(date +%d%H%M)_${{ github.event.inputs.device-codename }}-${{ github.event.inputs.release-type }}
      - name: "ðŸ’› Upload Image"
        uses: actions/upload-artifact@v4
        env:
          arch: arm64
        with:
          name: Image-${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}-${{ env.builddate }}
          path: out/arch/arm64/boot/Image
          if-no-files-found: ignore
          retention-days: 7

      - name: "ðŸ’™ Upload Image.gz"
        uses: actions/upload-artifact@v4
        env:
          arch: arm64
        with:
          name: Image.gz-${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}-${{ env.builddate }}
          path: out/arch/arm64/boot/Image.gz
          if-no-files-found: ignore
          retention-days: 7

      - name: "ðŸ’œ Upload dtb"
        uses: actions/upload-artifact@v4
        env:
          arch: arm64
        with:
          name: dtb-${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}-${{ env.builddate }}
          path: out/arch/arm64/boot/dts/qcom/sm6150.dtb
          if-no-files-found: ignore
          retention-days: 7

      - name: "â¤ï¸ Upload dtbo.img"
        uses: actions/upload-artifact@v4
        env:
          arch: arm64
        with:
          name: dtbo.img-${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}-${{ env.builddate }}
          path: out/arch/arm64/boot/dts/qcom/sm6150.dtbo
          if-no-files-found: ignore
          retention-days: 7

      - name: "â¤ï¸ Pack AnyKernel3.zip"
        if: ${{ env.useAnykernel == 'true' }}
        env:
          arch: arm64
          anykernel: "${{ env.WORKSPACE }}/${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}_${{ env.builddate }}"
        run: |
          ls -al

          if [ -e "out/arch/arm64/boot/Image.gz-dtb" ]; then
            cp -f out/arch/arm64/boot/Image.gz-dtb ./AnyKernel3/
          fi
          if [ -e "out/arch/arm64/boot/dts/qcom/sm6150.dtb" ]; then
            cp -f out/arch/arm64/boot/dts/qcom/sm6150.dtb ./AnyKernel3/
          fi
          if [ -e "out/arch/arm64/boot/dts/qcom/sm6150.dtbo" ]; then
            cp -f out/arch/arm64/boot/dts/qcom/sm6150.dtbo ./AnyKernel3/
          fi

          cd AnyKernel3/
          zip -q -r "${{ env.anykernel }}.zip" *

      - name: "ðŸ’¾ Upload AnyKernel3 image => (${{ env.builddate }})"
        uses: actions/upload-artifact@v4
        if: ${{ env.useAnykernel == 'true' }}
        with:
          name: "${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}_${{ env.builddate }}"
          path: AnyKernel3/*

      - name: ðŸ§§ Create GitHub Release => (${{ env.builddate }})
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        if: ${{ env.useAnykernel == 'true' && env.release == 'true' }}
        with:
          tag_name: v${{ env.builddate }}.${{ github.run_number }}
          files: "${{ env.WORKSPACE }}/${{ env.KERNEL_DEVICE }}-${{ env.KERNEL_NAME }}_${{ env.builddate }}.zip"
          generate_release_notes: false
